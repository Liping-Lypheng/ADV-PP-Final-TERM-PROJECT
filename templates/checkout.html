{% extends 'master.html' %}

{% block content %}
    <div class="container2">
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div id="item_box">
                <!-- Cart items will be inserted here by JavaScript -->
            </div>
            <div class="summary-section">
                <div class="summary-row">
                    <span class="summary-label">Subtotal:</span>
                    <span class="summary-value" id="label_subtotal">$0.00</span>
                </div>
                <div class="summary-total">
                    <span>Total (USD):</span>
                    <span id="label_total_usd">$0.00</span>
                </div>
                <div class="summary-total" style="border-top: none; padding-top: 0;">
                    <span>Total (KHR):</span>
                    <span id="label_total_kh">៛0</span>
                </div>
            </div>
            <a href="/cart" class="continue-shopping">← Back to Cart</a>
        </div>

        <div class="billing-address">
            <h1>Checkout</h1>
            <h2>Billing Address</h2>
            <form method="POST" action="/proceed" id="checkout-box">
                <label for="inputname">Full Name *</label>
                <input type="text" name="name" required placeholder="John Doe">

                <label for="inputemail">Email *</label>
                <input type="email" name="email" required placeholder="john@example.com">

                <label for="inputphone">Phone Number *</label>
                <input type="text" name="phone" required placeholder="+855 12 345 678">

                <label for="inputaddress">Address *</label>
                <input type="text" name="address" required placeholder="Street 123, Phnom Penh">
                <input type="hidden" id="cart_item" name="cart_item">
                <button type="submit">Place Order</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block custom_script %}
<script>
  let item_box = document.getElementById('item_box')
  let carts = JSON.parse(localStorage.getItem('carts') ?? '[]')
    document.getElementById('cart_item').value = JSON.stringify(carts)
  let cart_item_html = ''
  let total = 0
  carts.forEach((item) => {
    let price = parseFloat(item.price) || 0
    let qty = parseFloat(item.qty) || 1
    const itemTotal = qty * price
    total += itemTotal
    cart_item_html += `
      <div class="cart-item">
        <div class="item-details">
          <strong class="cart-item-title">${item.title}</strong>
        </div>
        <div class="quantity">
          <label for="qty_${item.id}">Qty:</label>
          <div id="qty_${item.id}">${item.qty} x $${item.price}</div>
        </div>
        <div class="cart-item-price">= $${item.price * item.qty}</div>
      </div>
    `;
  });
  let total_khr = Math.ceil(total*4100 /100) *100
  item_box.innerHTML = cart_item_html;
  document.getElementById('label_subtotal').innerHTML = `$ ${total.toFixed(2)}`
  document.getElementById('label_total_usd').innerHTML = `$ ${total.toFixed(2)}`
  document.getElementById('label_total_kh').innerHTML =  `៛ ${total_khr.toLocaleString()}`

  document.getElementById("checkout-box").addEventListener("submit", function() {
        document.getElementById("cart-item").value = JSON.stringify(carts);
    });
</script>
{% endblock %}